# OpenVPN

## Table of contents

- [OpenVPN server configuration](#openvpn-server-configuration)
- [Who needs what?](#who-needs-what)
- [OpenVPN for Android](#openvpn-for-android)
- [OpenVPN for GNU/Linux client](#openvpn-for-gnulinux-client)
- [OpenVPN for Windows](#openvpn-for-windows)

## OpenVPN server configuration

Root certificate
```bash
root@server:~$ apt-get install openvpn
root@server:~$ cp /usr/share/doc/openvpn/examples/easy-rsa ~/openvpn/ -R
root@server:~/openvpn/2.0/$ cd ~/openvpn/2.0/
root@server:~/openvpn/2.0/$ vim vars
root@server:~/openvpn/2.0/$ . ./vars
root@server:~/openvpn/2.0/$ ./clean-all
root@server:~/openvpn/2.0/$ ./build-ca
```

Certicate and server' key
```bash
root@server:~/openvpn/2.0/$ ./build-key-server server
```

Certicate and clients' keys
```bash
root@server:~/openvpn/2.0/$ ./build-key client1
```

Diffie-Hellman
```bash
root@server:~/openvpn/2.0/$ ./build-dh
```

Server configuration
```bash
root@server:~/openvpn/2.0/$ cp keys/dh*.pem keys/ca.crt keys/server.crt keys/server.key /etc/openvpn/
root@server:~/openvpn/2.0/$ cd /usr/share/doc/openvpn/examples/sample-config-files
root@server:/usr/share/doc/openvpn/examples/sample-config-files$ gunzip server.conf.gz
root@server:/usr/share/doc/openvpn/examples/sample-config-files$ cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/
```

Edit /etc/openvpn/server.conf, you can give it following settings for instance:
```bash
push "redirect-gateway" ;or push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 208.67.222.222" ;OpenDNS
push "dhcp-option DNS 208.67.220.220"
```

Enable ip forward: these commands have to be run at each restart
```bash
root@server:~$ iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
root@server:~$ echo "1" > /proc/sys/net/ipv4/ip_forward
root@server:~$ service openvpn restart
```

NOTE: you can change the password of a certificate by running
```bash
root@server:~/openvpn/2.0/$ openssl rsa -des3 -in client1.key -out client1.bis.key
```

NOTE: OpenVPN has a way to debug configuration files for both server and client
```bash
root@server:~$ cd /etc/openvpn && openvpn server.conf #server
root@client:~$ cd /etc/openvpn && openvpn client.conf #client
```

## Who needs what?

Both server and client:
- ca.crt

Server only:
- server.crt
- server.key
- dh1024.pem

Client only:
- client.crt
- client.key

## OpenVPN for Android

[Available on Play Store](https://play.google.com/store/apps/details?id=net.openvpn.openvpn)

Android version requires a specific key that can be generated using:
```bash
root@server:~$ openssl pkcs12 -export -in client1.crt -inkey client1.key -certfile ca.crt -name client1 -out client1.p12
```

## OpenVPN for GNU/Linux client

```bash
root@client:~$ apt-get install openvpn network-manager-openvpn
```

Retrieve certificates generated by the server
```bash
root@client:~$ cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn
root@client:~$ vim /etc/openvpn/client.conf
root@client:~$ scp server:openvpn/2.0/keys/ca.crt ~
root@client:~$ scp server:openvpn/2.0/keys/client1.crt ~
root@client:~$ scp server:openvpn/2.0/keys/client1.key ~
root@client:~$ mv ~/ca.crt ~/client1.crt ~/client1.key /etc/openvpn/
```

Configure network-manager-openvpn to use LZ0 compression (if set on server-side too)
- Réseaux > Connexions VPN > Configurer le VPN..
- Sélectionner le VPN à modifier
- Cliquer sur modifier
- VPN > Avancé.. > Utiliser la compression de données LZO

Prevent the machine from logging on the VPN automatically
```bash
root@client:~$ update-rc.d openvpn remove
```

# OpenVPN for Windows

[Available on OpenVPN official website](https://openvpn.net/index.php/open-source/downloads.html)
